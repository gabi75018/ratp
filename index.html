<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Poste RER C - Simulation</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: #050608;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      padding: 12px 24px;
      background: #111318;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #22252b;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #f7d117;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
      color: #000;
    }

    .line-label {
      font-size: 13px;
      color: #f7d117;
      font-weight: 600;
    }

    .station-name {
      font-size: 20px;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
      color: #c5c5c5;
    }

    .clock {
      font-variant-numeric: tabular-nums;
      font-size: 16px;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: 3fr 2fr;
      min-height: 0;
    }

    .board {
      padding: 20px 24px;
      border-right: 1px solid #22252b;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .board-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
    }

    .board-title {
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9fa3b5;
    }

    .board-subtitle {
      font-size: 13px;
      color: #7f8494;
    }

    .filters {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filters select {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #333745;
      background: #050608;
      color: #f5f5f5;
      font-size: 13px;
    }

    .filters button {
      padding: 4px 8px;
      border-radius: 4px;
      border: none;
      background: #303342;
      color: #f5f5f5;
      font-size: 12px;
      cursor: pointer;
    }

    .filters button.active {
      background: #1f6feb;
    }

    .table-wrapper {
      flex: 1;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #22252b;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #111318;
      z-index: 1;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #8b90a0;
    }

    th, td {
      padding: 8px 8px;
      border-bottom: 1px solid #22252b;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #101219;
    }

    tbody tr:nth-child(odd) {
      background: #080a10;
    }

    tbody tr.highlight {
      animation: highlight 0.8s ease-out;
    }

    @keyframes highlight {
      from { background-color: #264f78; }
      to { background-color: inherit; }
    }

    .line-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 26px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      color: #000;
      background: #f7d117;
    }

    .time {
      font-variant-numeric: tabular-nums;
      text-align: right;
      font-weight: 600;
    }

    .status {
      font-size: 12px;
      text-align: right;
      font-weight: 500;
    }

    .status-OK { color: #00d084; }
    .status-APPROCHE { color: #ffb347; }
    .status-QUAI { color: #f7d117; }
    .status-DEPART { color: #9fa3b5; }
    .status-SUIVANT { color: #7f8494; }

    .controls {
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .controls h2 {
      margin: 0 0 4px;
      font-size: 16px;
    }

    .controls p {
      margin: 0 0 10px;
      font-size: 12px;
      color: #a0a4b3;
    }

    .control-section {
      border-radius: 8px;
      border: 1px solid #22252b;
      padding: 10px 12px;
      background: #0b0d13;
    }

    .control-section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #d0d3df;
    }

    .control-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .control-row-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    label {
      font-size: 11px;
      color: #9fa3b5;
      display: block;
      margin-bottom: 2px;
    }

    select, input[type="number"], input[type="text"] {
      width: 100%;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #333745;
      background: #050608;
      color: #f5f5f5;
      font-size: 12px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    button {
      border: none;
      border-radius: 4px;
      padding: 5px 9px;
      font-size: 12px;
      cursor: pointer;
      background: #1f6feb;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    button.secondary {
      background: #303342;
    }

    button.danger {
      background: #d73a49;
    }

    button.warning {
      background: #ffb347;
      color: #000;
    }

    button:active {
      transform: translateY(1px);
    }

    .badge-live {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #f7d117;
    }

    .badge-live-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f7d117;
      box-shadow: 0 0 8px #f7d117;
    }

    footer {
      padding: 6px 24px;
      font-size: 11px;
      color: #7b7f8f;
      border-top: 1px solid #22252b;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #050608;
    }

    @media (max-width: 1100px) {
      main {
        grid-template-columns: 1fr;
      }
      .board {
        border-right: none;
        border-bottom: 1px solid #22252b;
      }
    }

    @media (max-width: 700px) {
      .control-row, .control-row-3 {
        grid-template-columns: 1fr;
      }
    }

    .line-diagram {
      font-size: 11px;
      color: #9fa3b5;
      margin-top: 6px;
      white-space: nowrap;
      overflow-x: auto;
    }

    .line-diagram span {
      display: inline-block;
      padding: 2px 6px;
      margin-right: 2px;
      border-radius: 999px;
      border: 1px solid #333745;
    }

    .line-diagram span.current {
      background: #f7d117;
      color: #000;
      border-color: #f7d117;
    }
  </style>
</head>
<body>
<header>
  <div class="header-left">
    <div class="logo">C</div>
    <div>
      <div class="line-label">RER C — Simulation</div>
      <div class="station-name" id="current-station-label">Gare observée : Paris Austerlitz</div>
    </div>
  </div>
  <div class="header-right">
    <span class="badge-live">
      <span class="badge-live-dot"></span>
      Circulation simulée en temps réel
    </span>
    <span class="clock" id="clock"></span>
  </div>
</header>

<main>
  <section class="board">
    <div class="board-header">
      <div>
        <div class="board-title">Prochains trains à quai / à l’approche</div>
        <div class="board-subtitle" id="board-subtitle">Vue locale — Paris Austerlitz</div>
      </div>
      <div style="font-size:11px; color:#7f8494;" id="stats"></div>
    </div>

    <div class="filters">
      <label for="station-select" style="font-size:12px;">Gare observée :</label>
      <select id="station-select"></select>
      <button id="dir-all" class="active">Tous sens</button>
      <button id="dir-up">Vers amont</button>
      <button id="dir-down">Vers aval</button>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>Mission</th>
          <th>Destination</th>
          <th>Origine</th>
          <th>État</th>
          <th>Dans</th>
        </tr>
        </thead>
        <tbody id="board-body">
        </tbody>
      </table>
    </div>

    <div class="line-diagram" id="line-diagram"></div>
  </section>

  <aside class="controls">
    <h2>Panneau de régulation RER C</h2>
    <p>Tu contrôles la circulation : ajout, retrait, position, sens, missions… Les trains se déplacent de gare en gare.</p>

    <!-- Section sélection train -->
    <div class="control-section">
      <div class="control-section-title">Sélection du train</div>
      <div class="control-row">
        <div>
          <label for="train-select">Train en circulation</label>
          <select id="train-select"></select>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="btn-row">
            <button class="secondary" onclick="scrollToSelected()">Voir dans la liste</button>
            <button class="danger" onclick="removeSelectedTrain()">Retirer de la circulation</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Section modification train -->
    <div class="control-section">
      <div class="control-section-title">Modifier le train sélectionné</div>
      <div class="control-row-3">
        <div>
          <label for="edit-mission">Mission</label>
          <input type="text" id="edit-mission" placeholder="ex : NORA">
        </div>
        <div>
          <label for="edit-dest">Destination</label>
          <input type="text" id="edit-dest" placeholder="ex : Pontoise">
        </div>
        <div>
          <label for="edit-origin">Origine</label>
          <input type="text" id="edit-origin" placeholder="ex : Massy Palaiseau">
        </div>
      </div>
      <div class="control-row-3">
        <div>
          <label for="edit-pos">Position (gare)</label>
          <select id="edit-pos"></select>
        </div>
        <div>
          <label for="edit-dir">Sens</label>
          <select id="edit-dir">
            <option value="1">Aval →</option>
            <option value="-1">← Amont</option>
          </select>
        </div>
        <div>
          <label for="edit-dwell">Temps à quai (s)</label>
          <input type="number" id="edit-dwell" min="0" value="30">
        </div>
      </div>
      <div class="btn-row">
        <button onclick="applyEdit()">Appliquer</button>
        <button class="secondary" onclick="forceDwell()">Forcer arrêt ici</button>
      </div>
    </div>

    <!-- Section ajout train -->
    <div class="control-section">
      <div class="control-section-title">Ajouter un train à la circulation</div>
      <div class="control-row-3">
        <div>
          <label for="add-mission">Mission</label>
          <input type="text" id="add-mission" placeholder="ex : NORA">
        </div>
        <div>
          <label for="add-origin">Origine</label>
          <select id="add-origin"></select>
        </div>
        <div>
          <label for="add-dest">Destination</label>
          <select id="add-dest"></select>
        </div>
      </div>
      <div class="control-row-3">
        <div>
          <label for="add-pos">Position initiale</label>
          <select id="add-pos"></select>
        </div>
        <div>
          <label for="add-dir">Sens</label>
          <select id="add-dir">
            <option value="1">Aval →</option>
            <option value="-1">← Amont</option>
          </select>
        </div>
        <div>
          <label for="add-offset">Décalage (min)</label>
          <input type="number" id="add-offset" min="-10" max="30" value="0">
        </div>
      </div>
      <div class="btn-row">
        <button onclick="addTrain()">Ajouter le train</button>
      </div>
    </div>

    <!-- Section modes de simulation -->
    <div class="control-section">
      <div class="control-section-title">Modes de simulation</div>
      <div class="btn-row">
        <button class="secondary" onclick="setPreset('NORMAL')">Trafic normal</button>
        <button class="warning" onclick="setPreset('RUSH')">Heure de pointe</button>
        <button class="secondary" onclick="setPreset('NUIT')">Service réduit</button>
        <button class="danger" onclick="clearAllTrains()">Tout retirer</button>
      </div>
    </div>
  </aside>
</main>

<footer>
  <span>Simulation non officielle — RER C simplifié, juste pour jouer au régulateur.</span>
  <span>Tick simulation : 2s — <button class="secondary" onclick="toggleSimulation()"><span id="sim-btn-label">Pause</span></button></span>
</footer>

<script>
  // --- Modèle de ligne RER C simplifié ---
  // On prend un axe unique Pontoise ↔ Massy, avec quelques gares emblématiques.
  const STATIONS = [
    "Pontoise",
    "Neuville-Université",
    "Conflans-Fin d'Oise",
    "Argenteuil",
    "Gennevilliers",
    "Invalides",
    "Musée d'Orsay",
    "Saint-Michel Notre-Dame",
    "Paris Austerlitz",
    "Bibliothèque François Mitterrand",
    "Choisy-le-Roi",
    "Juvisy",
    "Savigny-sur-Orge",
    "Épinay-sur-Orge",
    "Massy Palaiseau"
  ];

  const SEGMENT_MINUTES = 3; // temps moyen entre deux gares
  const DWELL_DEFAULT = 30;  // temps à quai par défaut (secondes)
  const TICK_MS = 2000;      // 2 secondes par tick

  let trains = [];
  let lastId = 0;
  let simulationRunning = true;

  // Direction: +1 = vers aval (index croissant), -1 = vers amont (index décroissant)

  function createTrain({mission, originIndex, destIndex, positionIndex, direction, offsetMinutes}) {
    return {
      id: ++lastId,
      mission: mission || ("C" + lastId),
      originIndex,
      destIndex,
      positionIndex,   // index de la gare actuelle (ou la plus proche)
      direction,       // +1 ou -1
      progress: 0,     // 0 = en gare, 0-1 = entre deux gares
      dwellRemaining: 0, // temps restant à quai (s)
      offset: offsetMinutes * 60, // décalage initial (s)
      active: true
    };
  }

  // --- Initialisation de quelques trains réalistes ---

  function generateInitialTrains(mode = "NORMAL") {
    const list = [];

    function add(mission, originName, destName, posName, dir, offsetMin) {
      const originIndex = STATIONS.indexOf(originName);
      const destIndex = STATIONS.indexOf(destName);
      const positionIndex = STATIONS.indexOf(posName);
      if (originIndex === -1 || destIndex === -1 || positionIndex === -1) return;
      list.push(createTrain({
        mission,
        originIndex,
        destIndex,
        positionIndex,
        direction: dir,
        offsetMinutes: offsetMin
      }));
    }

    if (mode === "NORMAL" || mode === "RUSH") {
      add("NORA", "Pontoise", "Massy Palaiseau", "Conflans-Fin d'Oise", 1, -2);
      add("CIME", "Pontoise", "Juvisy", "Gennevilliers", 1, 0);
      add("VICK", "Massy Palaiseau", "Pontoise", "Juvisy", -1, -1);
      add("GOTA", "Juvisy", "Pontoise", "Choisy-le-Roi", -1, 3);
      add("ELBA", "Massy Palaiseau", "Pontoise", "Savigny-sur-Orge", -1, 5);
      if (mode === "RUSH") {
        add("NORA", "Pontoise", "Massy Palaiseau", "Argenteuil", 1, 1);
        add("CIME", "Pontoise", "Juvisy", "Invalides", 1, 4);
        add("VICK", "Massy Palaiseau", "Pontoise", "Épinay-sur-Orge", -1, 2);
      }
    } else if (mode === "NUIT") {
      add("NORA", "Pontoise", "Massy Palaiseau", "Saint-Michel Notre-Dame", 1, 0);
      add("VICK", "Massy Palaiseau", "Pontoise", "Juvisy", -1, 4);
    }

    return list;
  }

  // --- Utilitaires temps / état ---

  function travelTimeBetween(i1, i2) {
    const segments = Math.abs(i2 - i1);
    return segments * SEGMENT_MINUTES * 60;
  }

  function etaToStation(train, stationIndex) {
    if (!train.active) return Infinity;

    // Si le train n'a pas encore "démarré" (offset positif)
    if (train.offset > 0) {
      // temps avant départ + temps de parcours
      const base = train.offset;
      const travel = travelTimeBetween(train.positionIndex, stationIndex);
      return base + travel;
    }

    // Train en circulation
    const dir = train.direction;
    const pos = train.positionIndex;
    const prog = train.progress;
    const dwell = train.dwellRemaining;

    // Si le train ne va pas dans le bon sens pour atteindre cette gare
    if ((dir === 1 && stationIndex < pos) || (dir === -1 && stationIndex > pos)) {
      return Infinity;
    }

    // Si le train est à quai à la gare observée
    if (stationIndex === pos && prog === 0 && dwell > 0) {
      return 0;
    }

    let time = 0;

    // Si en gare mais pas la bonne
    if (prog === 0) {
      time += dwell;
      const nextIndex = pos + dir;
      time += travelTimeBetween(pos, nextIndex);
      let currentIndex = nextIndex;
      while (currentIndex !== stationIndex) {
        const next = currentIndex + dir;
        time += travelTimeBetween(currentIndex, next);
        currentIndex = next;
      }
      return time;
    } else {
      // Entre deux gares
      const fromIndex = dir === 1 ? pos : pos - 1;
      const toIndex = fromIndex + dir;
      const segmentTime = travelTimeBetween(fromIndex, toIndex);
      const remainingSegment = (1 - prog) * segmentTime;
      time += remainingSegment;
      let currentIndex = toIndex;
      while (currentIndex !== stationIndex) {
        const next = currentIndex + dir;
        time += travelTimeBetween(currentIndex, next);
        currentIndex = next;
      }
      return time;
    }
  }

  function formatEta(seconds) {
    if (seconds === Infinity) return "—";
    if (seconds <= 0) return "À quai";
    const min = Math.floor(seconds / 60);
    const sec = Math.round(seconds % 60);
    if (min === 0) return sec + " s";
    return min + " min " + (sec < 10 ? "0" + sec : sec + " s");
  }

  function statusForEta(seconds) {
    if (seconds === Infinity) return {code: "SUIVANT", label: "Suivant plus tard"};
    if (seconds <= 0) return {code: "QUAI", label: "À quai"};
    const min = seconds / 60;
    if (min <= 0.5) return {code: "DEPART", label: "Départ imminent"};
    if (min <= 1.5) return {code: "APPROCHE", label: "Approche imminente"};
    if (min <= 5) return {code: "OK", label: "Arrive dans"};
    return {code: "SUIVANT", label: "Suivant dans"};
  }

  // --- Rendu ---

  function renderStationSelects() {
    const stationSelect = document.getElementById("station-select");
    const editPos = document.getElementById("edit-pos");
    const addOrigin = document.getElementById("add-origin");
    const addDest = document.getElementById("add-dest");
    const addPos = document.getElementById("add-pos");

    stationSelect.innerHTML = STATIONS.map((s, i) => `<option value="${i}">${s}</option>`).join("");
    editPos.innerHTML = STATIONS.map((s, i) => `<option value="${i}">${s}</option>`).join("");
    addOrigin.innerHTML = STATIONS.map((s, i) => `<option value="${i}">${s}</option>`).join("");
    addDest.innerHTML = STATIONS.map((s, i) => `<option value="${i}">${s}</option>`).join("");
    addPos.innerHTML = STATIONS.map((s, i) => `<option value="${i}">${s}</option>`).join("");

    stationSelect.value = STATIONS.indexOf("Paris Austerlitz");
  }

  function renderTrainSelect() {
    const select = document.getElementById("train-select");
    select.innerHTML = trains.map(t => {
      const posName = STATIONS[t.positionIndex] || "?";
      return `<option value="${t.id}">${t.mission} — ${posName} (${t.direction === 1 ? "→ aval" : "← amont"})</option>`;
    }).join("");
    if (trains.length > 0) {
      loadSelectedTrain(trains[0].id);
    } else {
      document.getElementById("edit-mission").value = "";
      document.getElementById("edit-dest").value = "";
      document.getElementById("edit-origin").value = "";
    }
  }

  function renderBoard() {
    const tbody = document.getElementById("board-body");
    tbody.innerHTML = "";

    const stationIndex = Number(document.getElementById("station-select").value);
    const dirFilter = getDirectionFilter();

    const enriched = trains
      .filter(t => t.active)
      .map(t => {
        const eta = etaToStation(t, stationIndex);
        return {train: t, eta};
      })
      .filter(e => e.eta !== Infinity)
      .filter(e => {
        if (dirFilter === 0) return true;
        return e.train.direction === dirFilter;
      })
      .sort((a, b) => a.eta - b.eta)
      .slice(0, 12);

    enriched.forEach(e => {
      const t = e.train;
      const eta = e.eta;
      const status = statusForEta(eta);
      const tr = document.createElement("tr");
      tr.dataset.id = t.id;

      const destName = STATIONS[t.destIndex] || "?";
      const originName = STATIONS[t.originIndex] || "?";

      tr.innerHTML = `
        <td><span class="line-badge">C</span> ${t.mission}</td>
        <td>${destName}</td>
        <td>${originName}</td>
        <td class="status status-${status.code}">${status.label}</td>
        <td class="time">${formatEta(eta)}</td>
      `;
      tbody.appendChild(tr);
    });

    // Stats
    const statsEl = document.getElementById("stats");
    statsEl.textContent = `${trains.length} trains en circulation — gare observée : ${STATIONS[stationIndex]}`;

    // Titre
    document.getElementById("current-station-label").textContent =
      "Gare observée : " + STATIONS[stationIndex];
    document.getElementById("board-subtitle").textContent =
      "Vue locale — " + STATIONS[stationIndex];

    renderLineDiagram(stationIndex);
  }

  function renderLineDiagram(stationIndex) {
    const el = document.getElementById("line-diagram");
    el.innerHTML = STATIONS.map((s, i) => {
      const cls = i === stationIndex ? "current" : "";
      return `<span class="${cls}">${s}</span>`;
    }).join("");
  }

  function loadSelectedTrain(id) {
    const t = trains.find(tr => tr.id === Number(id));
    if (!t) return;
    document.getElementById("edit-mission").value = t.mission;
    document.getElementById("edit-origin").value = STATIONS[t.originIndex] || "";
    document.getElementById("edit-dest").value = STATIONS[t.destIndex] || "";
    document.getElementById("edit-pos").value = t.positionIndex;
    document.getElementById("edit-dir").value = t.direction;
    document.getElementById("edit-dwell").value = t.dwellRemaining || DWELL_DEFAULT;
  }

  function scrollToSelected() {
    const select = document.getElementById("train-select");
    const id = Number(select.value);
    const row = document.querySelector(`#board-body tr[data-id="${id}"]`);
    if (row) {
      row.scrollIntoView({behavior:"smooth", block:"center"});
      row.classList.add("highlight");
      setTimeout(() => row.classList.remove("highlight"), 1000);
    }
  }

  // --- Direction filter ---

  function getDirectionFilter() {
    const all = document.getElementById("dir-all").classList.contains("active");
    const up = document.getElementById("dir-up").classList.contains("active");
    const down = document.getElementById("dir-down").classList.contains("active");
    if (all || (!up && !down)) return 0;
    if (up) return -1;
    if (down) return 1;
    return 0;
  }

  function setupDirectionButtons() {
    const btnAll = document.getElementById("dir-all");
    const btnUp = document.getElementById("dir-up");
    const btnDown = document.getElementById("dir-down");

    btnAll.addEventListener("click", () => {
      btnAll.classList.add("active");
      btnUp.classList.remove("active");
      btnDown.classList.remove("active");
      renderBoard();
    });
    btnUp.addEventListener("click", () => {
      btnAll.classList.remove("active");
      btnUp.classList.add("active");
      btnDown.classList.remove("active");
      renderBoard();
    });
    btnDown.addEventListener("click", () => {
      btnAll.classList.remove("active");
      btnUp.classList.remove("active");
      btnDown.classList.add("active");
      renderBoard();
    });
  }

  // --- Actions régulateur ---

  function applyEdit() {
    const select = document.getElementById("train-select");
    const id = Number(select.value);
    const t = trains.find(tr => tr.id === id);
    if (!t) return;

    t.mission = document.getElementById("edit-mission").value || t.mission;

    const originName = document.getElementById("edit-origin").value;
    const destName = document.getElementById("edit-dest").value;
    const originIndex = STATIONS.indexOf(originName);
    const destIndex = STATIONS.indexOf(destName);
    if (originIndex !== -1) t.originIndex = originIndex;
    if (destIndex !== -1) t.destIndex = destIndex;

    t.positionIndex = Number(document.getElementById("edit-pos").value);
    t.direction = Number(document.getElementById("edit-dir").value);
    t.dwellRemaining = Number(document.getElementById("edit-dwell").value) || 0;
    t.progress = 0;
    t.offset = 0;

    renderBoard();
    renderTrainSelect();
    document.getElementById("train-select").value = t.id;
    loadSelectedTrain(t.id);
  }

  function forceDwell() {
    const select = document.getElementById("train-select");
    const id = Number(select.value);
    const t = trains.find(tr => tr.id === id);
    if (!t) return;
    t.progress = 0;
    t.dwellRemaining = Number(document.getElementById("edit-dwell").value) || DWELL_DEFAULT;
    t.offset = 0;
    renderBoard();
  }

  function addTrain() {
    const mission = document.getElementById("add-mission").value || ("C" + (lastId + 1));
    const originIndex = Number(document.getElementById("add-origin").value);
    const destIndex = Number(document.getElementById("add-dest").value);
    const posIndex = Number(document.getElementById("add-pos").value);
    const dir = Number(document.getElementById("add-dir").value);
    const offsetMin = Number(document.getElementById("add-offset").value) || 0;

    const t = createTrain({
      mission,
      originIndex,
      destIndex,
      positionIndex: posIndex,
      direction: dir,
      offsetMinutes: offsetMin
    });
    trains.push(t);
    renderBoard();
    renderTrainSelect();
    document.getElementById("train-select").value = t.id;
    loadSelectedTrain(t.id);
  }

  function removeSelectedTrain() {
    const select = document.getElementById("train-select");
    const id = Number(select.value);
    trains = trains.filter(t => t.id !== id);
    renderBoard();
    renderTrainSelect();
  }

  function setPreset(mode) {
    trains = generateInitialTrains(mode);
    renderBoard();
    renderTrainSelect();
  }

  function clearAllTrains() {
    trains = [];
    renderBoard();
    renderTrainSelect();
  }

  // --- Simulation ---

  function tickSimulation() {
    if (!simulationRunning) return;

    trains.forEach(t => {
      if (!t.active) return;

      // Gestion du décalage initial
      if (t.offset > 0) {
        t.offset -= TICK_MS / 1000;
        if (t.offset < 0) t.offset = 0;
        return;
      }

      // Si à quai
      if (t.progress === 0 && t.dwellRemaining > 0) {
        t.dwellRemaining -= TICK_MS / 1000;
        if (t.dwellRemaining < 0) t.dwellRemaining = 0;
        return;
      }

      // Si en gare mais plus de dwell, on part
      if (t.progress === 0 && t.dwellRemaining <= 0) {
        // Si on est au terminus
        if ((t.direction === 1 && t.positionIndex >= t.destIndex) ||
            (t.direction === -1 && t.positionIndex <= t.destIndex)) {
          t.active = false;
          return;
        }
        // On commence à rouler vers la gare suivante
        t.progress = 0.01;
        return;
      }

      // En ligne entre deux gares
      if (t.progress > 0) {
        const segmentTime = SEGMENT_MINUTES * 60;
        const delta = (TICK_MS / 1000) / segmentTime;
        t.progress += delta;
        if (t.progress >= 1) {
          // Arrivée en gare suivante
          t.positionIndex += t.direction;
          t.progress = 0;
          t.dwellRemaining = DWELL_DEFAULT;
        }
      }
    });

    // Nettoyage des trains arrivés au terminus et inactifs
    trains = trains.filter(t => t.active || t.offset > 0 || t.dwellRemaining > 0);

    renderBoard();
    renderTrainSelect();
  }

  function toggleSimulation() {
    simulationRunning = !simulationRunning;
    document.getElementById("sim-btn-label").textContent = simulationRunning ? "Pause" : "Reprendre";
  }

  // --- Horloge ---

  function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent =
      now.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  }

  // --- Init ---

  function init() {
    renderStationSelects();
    trains = generateInitialTrains("NORMAL");
    renderBoard();
    renderTrainSelect();
    setupDirectionButtons();
    updateClock();
    setInterval(updateClock, 1000);
    setInterval(tickSimulation, TICK_MS);

    document.getElementById("station-select").addEventListener("change", renderBoard);
    document.getElementById("train-select").addEventListener("change", (e) => {
      loadSelectedTrain(e.target.value);
    });
  }

  init();
</script>
</body>
</html>

